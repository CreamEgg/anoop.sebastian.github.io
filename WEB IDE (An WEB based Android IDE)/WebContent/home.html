<!DOCTYPE html>
<html>
<head>

<title>Web IDE for Android</title>

<link href="resources/css/ext-all.css" rel="stylesheet" type="text/css" />
<link rel="shortcut icon" href="img/android.png">
<style type="text/css">

/*top tool bar*/
#toolbar-1009 {
    background: #157fcc;
}

/*top toolbar border*/
.x-toolbar-default {
    border-width: 5px;
    border-color: #3892d3;
}

/*menu item*/
.x-btn-default-toolbar-small {
    background-image: none;
    border-radius: 22px;
    -moz-border-radius: 22px;
    -o-border-radius: 22px;
    -webkit-border-radius: 22px;
}

/*menu button*/
.x-btn-default-toolbar-small .x-btn-inner {
    color: #3892d3;
    font-size: 13px;
}

/*search bar*/
.x-form-text {
    border-radius: 10px;
}

/*Tool bar text*/
.x-toolbar-text {
    color: #fff;
    font-size: 14px;
    font-weight: bold;
}

.x-form-trigger-wrap {
    border: none !important;
}

</style>

<script src="resources/ext-all-debug.js" type="text/javascript"></script>
<script src="resources/src/ux/aceeditor/ace-0.2.0/src/ace.js" type="text/javascript"></script>
<script src="resources/src/ux/aceeditor/Panel.js" type="text/javascript"></script>
<script>

    var editor, code, sourcecode, nodeText, tabPanel, tabBar, tabIndex, projectName, combo,
        selectedItem = null;
    
    var bytesRead = 0;
    var temp,temp2;

    var api  = [{text:"AbortReceiver",url:"android/app/activity"},{text:"AbsActionBarView",url:"android/support/v7/internal/widget"}];
    var PROJECTNAME = getRemoteData(false, "home?action=currentproject", "GET");            
    PROJECTNAME = PROJECTNAME[0];
    console.log("Current Project: "+ PROJECTNAME);
    /*
       function to get the file content type for making http requests
       params: filename, which describes the name of the file
       returns the content type for the file
    */
    function getContentType(filename) {
        var fileExtension = filename.substring(filename.indexOf("."),filename.length);
        //console.log("Returned content type for : " + fileExtension);
        if (fileExtension === ".txt") return "text/plain"
        
        if (fileExtension === ".xml") return "text/xml"
        if (fileExtension === ".java") return "text/x-java-source"
    }

    /*
       function to get the file type from the filename to set the editor parser type
       params: filename, the name of the file
       returns the editor parser type
    */
    function getParserType(filename) {
        var fileExtension = filename.substring(filename.indexOf("."),
                filename.length);
        //console.log("Returned content type for : " + fileExtension);
        if (fileExtension === ".txt") return "text"

        if (fileExtension === ".xml") return "xml"
        
        if (fileExtension === ".java") return "java"

        return "text";
    }
    
    /*
       function to make asynchronous http requests to server
       params: async, is the request made asynchronous,
       requestURL, the url to make the HTTP request to,
       httpMethod, the type of HTTP request to be made
       returns the response and request status information     
    */
    function getRemoteData(async, requestURL, httpMethod) {
        var output = "Nothing to display", requestStatus;
        
        Ext.Ajax.request({
            async : async,
            url : requestURL,
            disableCaching : true, /*browser caching of ajax request */
            method : httpMethod,
            headers : {
                "Content-Type" : "text/html"
            },
            success : function(response, options) {
               // console.log("The Success function was called.");
                output = response.responseText;          
            },
            failure : function(response, options) {
                //console.log("The Failure function was called.");
                var statusCode = response.status;
                var statusText = response.statusText;
                requestStatus = "Status code: "+statusCode+" Status text: "+ statusText;
            },
            callback : function(options, success, response) {
                //console.log("The Callback function was called.");
                var statusCode = response.status;
                var statusText = response.statusText;
                //requestStatus = "Status code: "+statusCode+" Status text: "+ statusText;
                requestStatus = statusCode;
            },
            timeout : 60000
        });
        
        return [output, requestStatus];     
    }   
    
    // Menu button click handler
    var genericHandler = function(menuItem) {
        //Ext.MessageBox.alert("Menu Item", "Your choice is " + menuItem.text);
        if (menuItem.text == "Compile") {
             outputConsole.setValue("Please wait while you project is being compiled ...");
            var tabPanel = viewport.getComponent("mytabpanel");
            
            if (tabPanel.items.length > 0) {
                var activeTab = tabPanel.getActiveTab();            
                activeTab.fireEvent("deactivate", activeTab);           
                console.log("Active Tab: "+ activeTab.title);   
            } else console.log("No open tabs");

            Ext.MessageBox.show({ 
                msg: "Please wait while the project is being compiled ...", 
                progressText: "executing <ant> <debug> ", 
                width:600, 
                wait:true, 
                waitConfig: {interval:1000}
            });
            //  Asynchronously loading compilation output
            Ext.Ajax.request({
                async : true,
                url : "home?action=compile&name="+PROJECTNAME,
                disableCaching : true, /*browser caching of ajax request */
                method : "GET",
                success : function(response, options) {
                    console.log("Compiled successfulyy");
                    //output = response.responseText;
                    outputConsole.setValue(response.responseText);                    
                    //reload tree panel
                    westPanel.getStore().load();
                    
                    //reload error grid
                    Ext.getCmp("errorGrid").getStore().load();
                    Ext.MessageBox.hide();
                },
                failure : function(response, options) {
                    //console.log("The Failure function was called.");
                    //var statusCode = response.status;
                    //var statusText = response.statusText;
                    //requestStatus = "Status code: "+statusCode+" Status text: "+ statusText;
                	Ext.MessageBox.hide();
                },
                callback : function(options, success, response) {
                    //console.log("The Callback function was called.");
                    //var statusCode = response.status;
                    //var statusText = response.statusText;
                },
                timeout : 60000
            });
        } 
        else if (menuItem.text == "Reload") {            
            var compilationOutput = getRemoteData(false, "home?action=compile&name="+PROJECTNAME, "POST");            
            westPanel.getStore().load();
            outputConsole.setValue(compilationOutput[0]);
            //console.log("Compilation status: "+compilationOutput[1]);
            Ext.getCmp("errorGrid").getStore().load();
            
            //console.log("Tree + Output console + errorgrid reloaded");
        }
    }

    // menu item compile
    var compileAction = new Ext.Action({
        text : "Compile",
        handler : genericHandler
    });
    
    // menu item compile
    var reloadAction = new Ext.Action({
        text : "Reload",
        handler : genericHandler
    });

    var topToolbar = Ext.create('Ext.toolbar.Toolbar', {
        region : "north",
        items : [{
        	text: "Home",
            href: "index.html",
            hrefTarget : "_blank"
        }, {
            text : 'File',
            menu : [ compileAction, reloadAction]
        },         // begin using the right-justified button container
         // same as { xtype: 'tbfill' }
        {
        	xtype: "combo",
            hiddenName: "target",
            name : 'searchQuery',
            emptyText : "Search Android Docs",
            minWidth : 300,
            hideTrigger: true,
            queryMode: 'local',
            buffered: true,
            leadingBufferZone: 5,
            typeAhead: true,
            store : new Ext.data.Store({
                data : [{text:"android.app.activity.AbortReceiver"},{text:"android.support.v7.internal.widget.AbsActionBarView"},{text:"android.widget.AbsListView"},{text:"android.app.backup.AbsoluteFileBackupHelper"},{text:"android.widget.AbsoluteLayout"},{text:"android.text.style.AbsoluteSizeSpan"}],
                id: 0,
                fields: ["text"]
            }),
            listeners: {
                select : function( field, value, eOpt) { 
                	console.log("selected value: "+ field.getValue());
                	var packageName = field.getValue().split(".").join("/");
                	
                	console.log("https://developer.android.com/reference/"+packageName+".html");
                   window.open("https://developer.android.com/reference/"+packageName+".html"); 
                   
                    
                }
            }
        }]
    });
       
     var autocompletefields;
     
     Ext.Ajax.request({
         url : "home",
         async : false,
         disableCaching : false,
         method : "GET",
         params : {  
             "action" : "autocomplete",                 
         },
         success : function(response, options) {
        	 autocompletefields = response.responseText; 
             console.log(response.responseText);                                     
         },
         failure : function(response, options) {},
         callback : function(options, success, response) {},
         timeout : 60000
     });
     
     /*test combo box*/
    var combostore = Ext.create("Ext.data.Store", { 
           fields: ["text"], 
           data: api
     }); 
     
     
     
     console.log("testing...");
     combo = Ext.create('Ext.form.field.ComboBox', { 
        store : combostore,
        floating: true,
        hideTrigger: true,
        emptyText: "Start typing ...",
        queryMode: "local",
        buffered: true,
        minWidth : 300,
        leadingBufferZone: 5,
        typeAhead: true,
        listeners: {
            select : function(combo, record, options) {
                console.log("selected value: "+ combo.getValue());
                combo.setVisible(false);
                var edit = editor.getEditor();
                edit.insert(combo.getValue());
                
                //var line = editor.getEditor().selection.getCursor().row;
                console.log("Current line: "+editor.getEditor().selection.getCursor().row);
                
            }
        }
        //forceSelection: true,
       
        //triggerAction: "query" 
    }); 

    //---------------------------------------------------
    var westPanel = Ext.create('Ext.tree.Panel', {
        title : "Project Explorer",
        region : "west",
        margins : "0 0 0 5",
        width : 200,
        collapsible : true,
        animCollapse : true,
        split : true,
        store : new Ext.data.TreeStore({
            preloadChildren : false,
            folderSort : true,
            root : {
                text : "Root",
                draggable : true,
                expanded : true
            },
            proxy : {
                type : "ajax",
                url : "home?action=project&name="+PROJECTNAME,
                noCache: true
            }
        }),
        rootVisible : false,
        listeners : {
            itemclick : function(tree, record, item, index, e, options) {
                console.log("Node Index: "+ index);
                if (record.isLeaf()) {
                    var nodeText = record.data.text;
                    var tabPanel = viewport.getComponent("mytabpanel");
                    var tabBar = tabPanel.getTabBar();
                    var tabIndex;

                    for ( var i = 0; i < tabBar.items.length; i++) {
                        if (tabBar.items.get(i).getText() === nodeText) {
                            tabIndex = i;
                        }
                    }
                    console.log("Clicked on Node: " + record.data.text);
                    
                    var nodeContent = getRemoteData(false, "home?action=content&filepath="+record.get("id"), "GET");
                    sourcecode = nodeContent[0];
                    
                    if (Ext.isEmpty(tabIndex)) {
                        editor = Ext.create("Ext.ux.aceeditor.Panel", {
                            title : record.get("text"),
                            theme : "dreamweaver",
                            printMargin : true,
                            margins : "5 0 5 0",
                            itemId : record.get("text"),
                            parser : getParserType(record.get("text")),
                            closable : true,
                            animCollapse : true,
                            codeFolding : true,
                            sourceCode : sourcecode,
                            listeners : {
                                render: function(codepanel) {
                                    console.log("Code panale: "+ codepanel.el);
                                    codepanel.el.on('keypress',codepanel.myKeyHandler);
                                },
                                deactivate : function(panel, eOpts) {
                                    saveWhenDeactivated(panel, record);
                                    //console.log(panel.title   + " panel deactivated");
                                },
                                activate : function(panel, eOpts) {
                                    console.log(panel.title   + " panel activated");
                                }
                            },
                            myKeyHandler: function(event) {
                                
                                //TODO only add keyevents if the file name ends with .java
                                // if the key is "." or CTRL+SPACE
                                if(event.keyCode === event.ESC) {
                                    if (combo.isVisible()) {
                                        combo.setVisible(false);
                                    }
                                }
                                if((event.keyCode=== 46) ||(event.getKey() == event.SPACE && event.ctrlKey)) {
                                    console.log("the . or CTRL + SPACE is Pressed!");
                                    /*var menu = Ext.create('Ext.menu.Menu', {
                                        floating: true,
                                        plain: false,
                                        draggable: true,
                                        items: [{
                                            text: 'regular item 1'},
                                        {
                                            text: 'regular item 2'},
                                        {
                                            text: 'regular item 3'}]
                                    });*/
                                    
                                    /*combo.on("select", function(combo, records, eOpts) {
                                          console.log("selected value: "+ combo.getValue());
                                          var edit = editor.getEditor();
                                          edit.insert(combo.getValue());
                                          //console.log(this.getEditor().get);
                                          combo.setVisible(false);
                                    });*/
                                    
                                    if (!combo.isVisible()) {
                                        var dom = Ext.dom.Query.select('.ace_cursor');
                                        //hack to find the dom element index of the cursor from the tabindex
                                        var el = Ext.get(dom[tabIndex+1]);
                                        console.log("Cursor at: "+el.getXY());
                                        console.log("Combo xtype : "+ combo.getXType());
                                        combo.showAt(el.getXY());
                                    }
                                    
                                }/*
                                else if (event.getKey() == event.SPACE && event.ctrlKey) {
                                    console.log("ctrl or space was clicekd");
                                }*/
                                else {
                                    console.log("Other Key Pressed!, "+event.getCharCode()); 
                                    if (combo.isVisible()) {
                                        combo.setVisible(false);
                                    }
                                }
                            },
                        });
                        
                        tabPanel.add(editor).show();                        
                        tabIndex = tabPanel.items.length - 1;
                    }
                    tabPanel.setActiveTab(tabIndex);
                } else if(projectName == null){
                    projectName = record.data.text;
                    console.log("Project Name: "+ projectName);
                }
            }
        }
    });
    
    // Tree panel right click actions
    var createFolderAction = new Ext.Action({
        text : "Create New Folder", 
        handler : function createFile() {
            if(selectedItem != null || selectedItem != "undefined") {
                console.log("Selected item "+ selectedItem.get("id"));
                
                Ext.Msg.prompt("Create New Folder", 
                        "Please Enter Folder Name, e.g Awesome Folder.  You can create sub folders by adding"+ 
                        " slashes e.g Parent/Child/Grandchild", function(btn, text, cfg) {
                    
                    if(btn != "ok" && Ext.isEmpty(text)){
                        Ext.MessageBox.hide();
                        console.log("No new file");
                    }
                    else if(btn == "ok" && Ext.isEmpty(text)) {
                        var newMsg = '<span style="color:red">Please Enter Folder Name, e.g Awesome Folder.' 
                        +'You can create sub folders by adding slashes e.g Parent/Child/Grandchild</span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                    } else if(text.indexOf(".") != -1) {
                        console.log("no extension");
                        var newMsg = '<span style="color:red">It does not look right, remove that "." </span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                    } 
                    else {
                        text.replace("/","\\");
                        console.log("New Folder Name: "+ selectedItem.get("id")+"/"+text);
                        Ext.Ajax.request({
                            async : true,
                            url : "home?action=foldercreate&file="+selectedItem.get("id")+"/"+text,
                            disableCaching : true, /*browser caching of ajax request*/ 
                            method : "POST",
                            success : function(response, options) {
                                if (response.responseText === "success") {
                                    console.log("Folder Created Sucessfully");                    
                                    //reload tree panel
                                    westPanel.getStore().load();
                                    
                                    var temp = outputConsole.getValue(); 
                                    temp +="Folder "+selectedItem.get("id")+"/"+text+" created successfully\n"
                                    outputConsole.setValue(temp);
                                    //Ext.example.msg('Done', 'File Creates Successfully');
                                    
                                }
                                if (response.responseText === "fail") {
                                    outputConsole.setValue("Failed to create "+selectedItem.get("id")+"/"+text+".\nFolder already exits.");
                                }
                            },
                            failure : function(response, options) {},
                            callback : function(options, success, response) {},
                            timeout : 60000
                    });
                    }
                });
            }
        }
    });
    
    var renameFileAction = new Ext.Action({
        text : "Rename File / Folder", 
        handler : function createFile() {
            if(selectedItem != null || selectedItem != "undefined") {
                console.log("Selected item "+ selectedItem.get("id"));
                
                Ext.Msg.prompt("Rename File / Folder", 
                        "Please Enter The New Name", function(btn, text, cfg) {
                    
                    if(btn != "ok" && Ext.isEmpty(text)){
                        Ext.MessageBox.hide();
                        console.log("No new file");
                    }
                    else if(btn == "ok" && Ext.isEmpty(text)) {
                        var newMsg = '<span style="color:red">Please Enter The New Name</span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                    } else if(selectedItem.isLeaf() && text.indexOf(".") === -1) {
                        console.log("no extension");
                        var newMsg = '<span style="color:red">Did You Forget The File Extenstion. </span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                    } else if(!selectedItem.isLeaf() && text.indexOf(".") != -1) {
                        console.log("no extension");
                        var newMsg = '<span style="color:red">Remove the "." From The Folder Name. </span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                    }                    
                    else {
                        console.log("New Folder Name: "+ selectedItem.get("id")+"/"+text);
                        Ext.Ajax.request({
                            async : true,
                            url : "home?action=filerename&file="+selectedItem.get("id")+"&newname="+text,
                            disableCaching : true, /*browser caching of ajax request*/ 
                            method : "POST",
                            success : function(response, options) {
                                if (response.responseText === "success") {
                                    console.log("ProjectnAME: "+ text);
                                    console.log("File Renamed Sucessfully");                    
                                    //reload tree panel
                                    westPanel.getStore().load();
                                    
                                    var temp = outputConsole.getValue(); 
                                    temp +="File "+selectedItem.get("id")+" renamed successfully\n"
                                    outputConsole.setValue(temp);
                                    //Ext.example.msg('Done', 'File Creates Successfully');
                                    
                                }
                                if (response.responseText === "fail") {
                                    outputConsole.setValue("Failed to rename "+selectedItem.get("id")+".\nFolder already exits.");
                                }
                            },
                            failure : function(response, options) {},
                            callback : function(options, success, response) {},
                            timeout : 60000
                    });
                    }
                });
            }
        }
    });
    
    var deleteFolderAction = new Ext.Action({
        text : "Delete This Folder", 
        handler : function deleteFolder() {
            if(selectedItem != null || selectedItem != "undefined") {
                console.log("Selected item"+ selectedItem.get("id"));
                
                Ext.Msg.confirm("Deleting Directory "+selectedItem.get("text"), 
                        "Are you really sure you want to delete "+selectedItem.get("text")+
                        "?.It cannot be undone!", function (id, value) { 
                    if (id === 'yes') { 
                         console.log("ya sure");
                         Ext.Ajax.request({
                             async : true,
                             url : "home?action=folderdelete&file="+selectedItem.get("id"),
                             disableCaching : true, /*browser caching of ajax request*/ 
                             method : "POST",
                             success : function(response, options) {
                                 if (response.responseText != "fail") {
                                     console.log("Compiled successfulyy");                    
                                     //reload tree panel
                                     westPanel.getStore().load();
                                     //westPanel.expandPath("AndroidApplication");
                                     var temp = outputConsole.getValue();
                                     temp += response.responseText;
                                     temp +="\nFolder Deletion Successfull\n"
                                     outputConsole.setValue(temp);
                                 }
                             },
                             failure : function(response, options) {},
                             callback : function(options, success, response) {},
                             timeout : 60000
                     });
                    }
                    if (id === 'no') { 
                        console.log("File deletion cancelled");
                    }
                    }, this);
            }
        }
    });
    
    var createFileAction = new Ext.Action({
        text : "Create New File", 
        handler : function createFile() {
            if(selectedItem != null || selectedItem != "undefined") {
                console.log("Selected item "+ selectedItem.get("id"));
                
                Ext.Msg.prompt("Create New File", "Please Enter File Name, e.g MyAwesomeFile.txt", function(btn, text, cfg) {
                    
                    if(btn != "ok" && Ext.isEmpty(text)){
                        Ext.MessageBox.hide();
                        console.log("No new file");
                    }
                    else if(btn == "ok" && Ext.isEmpty(text)) {
                        var newMsg = '<span style="color:red">Please Enter File Name, e.g MyAwesomeFile.txt</span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                    } else if(text.indexOf(".") === -1) {
                        console.log("no extension");
                        var newMsg = '<span style="color:red">Looks like you forgot the file extension !</span>';
                        Ext.Msg.show(Ext.apply({}, { msg: newMsg }, cfg));
                        Ext.example.msg('Done', 'Your fake data was saved!');
                    } 
                    else {
                        console.log("New File Name: "+ selectedItem.get("id")+"/"+text);
                        Ext.Ajax.request({
                            async : true,
                            url : "home?action=filecreate&file="+selectedItem.get("id")+"/"+text,
                            disableCaching : true, /*browser caching of ajax request*/ 
                            method : "POST",
                            success : function(response, options) {
                                if (response.responseText === "success") {
                                    console.log("File Created Sucessfully");                    
                                    //reload tree panel
                                    westPanel.getStore().load();
                                    westPanel.expandPath(".");
                                    var temp = outputConsole.getValue(); 
                                    temp +="File "+selectedItem.get("id")+"/"+text+" created successfully\n"
                                    outputConsole.setValue(temp);
                                    //Ext.example.msg('Done', 'File Creates Successfully');
                                }
                                if (response.responseText === "fail") {
                                    outputConsole.setValue("Failed to create "+selectedItem.get("id")+"/"+text+".\nFile already exits.");
                                }
                            },
                            failure : function(response, options) {},
                            callback : function(options, success, response) {},
                            timeout : 60000
                    });
                    }
                });
            }
        }
    });
    
    var deleteFileAction = new Ext.Action({
        text : "Delete This File",
        handler : function createFile() {
            if(selectedItem != null || selectedItem != "undefined") {
                console.log("Selected item"+ selectedItem.get("id"));
                
                Ext.Msg.confirm("Deleting File "+selectedItem.get("text"), 
                        "Are you sure you want to delete "+selectedItem.get("text")+
                        "?.It cannot be undone!", function (id, value) { 
                    if (id === 'yes') { 
                         console.log("ya sure");
                         Ext.Ajax.request({
                             async : true,
                             url : "home?action=filedelete&file="+selectedItem.get("id"),
                             disableCaching : true, /*browser caching of ajax request*/ 
                             method : "POST",
                             success : function(response, options) {
                                 if (response.responseText === "success") {
                                     console.log("Compiled successfulyy");                    
                                     //reload tree panel
                                     westPanel.getStore().load();
                                     //westPanel.expandPath("AndroidApplication");
                                     var temp = outputConsole.getValue(); 
                                     temp +="\nFile Deletion Successfull\n"
                                     outputConsole.setValue(temp);
                                 }
                             },
                             failure : function(response, options) {},
                             callback : function(options, success, response) {},
                             timeout : 60000
                     });
                    }
                    if (id === 'no') { 
                        console.log("File deletion cancelled");
                    }
                    }, this);
            }
        }
    }); 
    
    
 
    var treeFolderMenu = Ext.create('Ext.menu.Menu', {
        items: [createFolderAction,createFileAction,renameFileAction,deleteFolderAction]
    });
    
    var treeFileMenu = Ext.create('Ext.menu.Menu', {
        items: [renameFileAction,deleteFileAction]
    });
    
    westPanel.on("itemcontextmenu", function(view, record, item, index, event){
        //treePanelCurrentNode = record;
        console.log("Tree menu clicked");
        selectedItem = record;
        if(record.isLeaf()) {
            treeFileMenu.showAt(event.getXY());
        } else {
            treeFolderMenu.showAt(event.getXY());
        }
        event.stopEvent();
    },this);
    
    // bottom panel -----------------------------------
    
    var outputConsole = Ext.create("Ext.ux.aceeditor.Panel", {
        title : "Output Console",
        //margin : "5px",
        theme : "clouds",
        printMargin : true,
        fontSize : "13px",
        parser : "text",        
        showGutter : true,
        codeFolding : true,
        sourceCode : "nothing yet",
        listeners:{
            render:function(panel){
                //panel.el.on('keypress',panel.myPanelKeyHandler);
            },
            activate: function(){
                //console.log("Panel activated: xtype: "+this.getXType());
                //var contentLength = this.getSession().getLength();
                //console.log("text length: "+contentLength);
                //this.getEditor().gotoLine(contentLength);
            },
            change : function() {
                //console.log("Panel changed: xtype: "+this.getXType());
                //console.log("Content changed");
                var contentLength = this.getSession().getLength();
                console.log("text length: "+contentLength);
                //this.getEditor().gotoLine(contentLength);
                
                // sets the cursor at the last line of the editor
                //this.getEditor.gotoLine(this.getSession().getLength());
                
                /*console.log("X: "+ this.getX());
                console.log("Y: "+this.getY());
                console.log("XY: "+this.getXY());
                var menu = Ext.create('Ext.menu.Menu', {
                    floating: true,
                    items: [{
                        text: 'regular item 1'},
                    {
                        text: 'regular item 2'},
                    {
                        text: 'regular item 3'}]
                });
                
                var dom = Ext.dom.Query.select('.ace_cursor');
                var el = Ext.get(dom[0]);
                console.log("Cursor at: "+el.getXY());
                menu.showAt(el.getXY());*/
            }
        }/*,
        myPanelKeyHandler:function(e){
            var key = e.getKey();
            if( key === e.ENTER ){
                console.log("ENTER Key Pressed!");
            }else {
                console.log("Other Key Pressed!, "+e.getCharCode());
                
            }
        }*/
     });
    
    //console.log("Output console element: "+outputConsole.getXType());
    
    /*Data model to represent the Error message in the error grid*/
    Ext.define("Message", {
        extend: "Ext.data.Model",
        fields: [
          {name: "type", type: "string"},
          {name: "file", type: "string"},
          {name: "linenumber", type: "string"},
          {name: "name", type: "string"},
          {name: "description", type: "string"}
        ]
        });
    
    /*Data model to represent the Log message in the log grid*/
    Ext.define("Log", {
        extend : "Ext.data.Model",
        fields: [
            {name: "message", type: "string"},
            {name: "type", type: "string"}]
    });
        
    var errorData = getRemoteData(false, "home?action=errordata&name="+PROJECTNAME, "GET")[0];
        console.log("Error data: "+ errorData);
        
    var errorStore = Ext.create("Ext.data.ArrayStore", {
        model: "Message",
        proxy : {
            type : "ajax",
            url : "home?action=errordata&name="+PROJECTNAME
        }
    });
    
    var logStore = Ext.create("Ext.data.ArrayStore", {
    	//autoLoad: true,
        model: "Log",
        proxy : {
            type : "ajax",
            url : "home?action=getlog&name="+PROJECTNAME+"&bytes="+bytesRead,
            timeout: 60000 /*30 seconds*/                   
        },
        listeners : {
            add : function(store, records, index, eOpts) {
                var logGrid = Ext.getCmp("logGrid");
                if(logGrid !=null) {
                    console.log("New logs are added to log store");                    
                    var row = store.getCount();
                    
                    console.log("store count: "+row);
                    //var gridView = logGrid.getView();
                    
                    //logGrid.setScrollTop(row);
                    //gridView.focusRow(index,false);
                    //logGrid.getView().refresh();*/
                }
            },
            /*load : function(store, records, successful, eOpts) {
                if(successful) {
                    bytesRead = getRemoteData(false, "home?action=getlog&name="+PROJECTNAME, "GET")[0];
                    console.log(successful+" Store loaded, latest file size: "+ bytesRead);
                }
            }*/
        }
    });
    
    var myData =  
      [["message one","error"],
      ["message two","debug"],
      ["message three","info"],
      ["message four","info"],
      ["message five","warning"],
      ["message three","verbose"],];
    
    
    var time;
        
    function myTimer()
    {
        lazyLoadLogStore();
    }
    
    function lazyLoadLogStore() {
        //bytesRead = getRemoteData(false, "home?action=getlog&name="+PROJECTNAME, "GET")[0];
        //getRemoteData(false, "home?action=getlog&name="+PROJECTNAME+"&bytes="+bytesRead, "GET")[0];
        //var newLogs = getRemoteData(false, "home?action=getlog&name="+PROJECTNAME+"&bytes="+bytesRead, "GET")[0];
        
        console.log("Bytes read: "+ bytesRead);
        
        Ext.Ajax.request({
            url : "home?action=getlog&name="+PROJECTNAME+"&bytes="+bytesRead,
            //disableCaching : false,
            method : "GET",
            success : function(response, options) {
            	//logStore.add(myData);
            	logStore.add(response.responseText);
            	logStore.load();
            	bytesRead = getRemoteData(false, "home?action=getlog&name="+PROJECTNAME, "GET")[0];
            	console.log("New Log: "+response.responseText);
            },
            failure : function(response, options) {},
            callback : function(options, success, response) {},
            timeout : 60000
        });
    }
    
    var LogConsole = Ext.create("Ext.grid.Panel", {
        title: "Log",
        id: "logGrid",
        store: logStore,
        stripeRows: true,
        deferRowRender: false,
        selType: "cellmodel",
        emptyText: "No Logs to display",
        columns: [ new Ext.grid.RowNumberer(),{ header: "Logs", 
                    dataIndex: "message", 
                    flex: 1, 
                    renderer: function(value, metaData, record, rowIndex, colIndex, store) {
                        //console.log("Message: "+ record.get("message")+" Type: "+record.get("type"));             
                        if(record.get("type") == "debug") 
                            return '<span style="color:blue;"><strong>Debug : ' + value + '</strong></span>';
                        if(record.get("type") == "error")  
                            return '<span style="color:red;"><strong>Error : ' + value + '</strong></span>';
                        if(record.get("type") == "info")  
                            return '<span style="color:green;"><strong>Info : ' + value + '</strong></span>';
                        if(record.get("type") == "warning")  
                            return '<span style="color:orange;"><strong>Warning : ' + value + '</strong></span>';
                        if(record.get("type") == "verbose")  
                            return '<span style="color:black;"><strong>Verbose : ' + value + '</strong></span>';                      
                    }}],
        listeners :{
            activate : function() {
                bytesRead = getRemoteData(false, "home?action=getlog&name="+PROJECTNAME, "GET")[0];
                console.log("First file size: "+ bytesRead);
                logStore.load();
                time = setInterval(myTimer,5000);
            },
            deactivate: function() {
                window.clearInterval(time);
                Ext.Ajax.request({
                    url : "home?action=getlog&name="+PROJECTNAME,
                    //disableCaching : false,
                    method : "GET",
                    params : {  
                        "logflag" : "stoplog"                 
                    },
                    success : function(response, options) {
                        //console.log(response.responseText);                                     
                    },
                    failure : function(response, options) {
                        //console.log('The Failure function was called.');                                      
                    },
                    callback : function(options, success, response) {
                        //console.log('The Callback function was called.');
                        //console.log('Successful Request? ' + success);                  
                    },
                    timeout : 60000
                });
            },
            added : function(store, records, index, eOpts){
                console.log("new items added to store");              
                 //console.log(this.getXType());
                 //console.log(this.getView().getXType());
                 ///console.log(store.getXType());
                 //console.log("items in store"+store.getTotalCount());
            },
            itemclick : function(view, record, item, index, e, eOpts) {
                //logStore.add(myData);
                 console.log("Row: "+index+" "+record.get("message")+" type: "+record.get("type"));
               //this.getSelectionModel().setCurrentPosition({row: pos, column: 1});
               
               // view.focusRow(logStore.getCount(),false);
            }
        },
        viewConfig:{
        	loadMask:false,
            listeners : {
                added: function(container, pos, eOpts ) {
                    //console.log(this.getXType());
                    console.log("row added");
                    //this.getSelectionModel().setCurrentPosition({row: pos, column: 1});
                    //var parent = this.ownerCt;
                    //parent.getView().focusRow(8,false);
                }
            }
        }
    });
    
    function listenForLogs() {
        logStore.load();
        console.log("Getting logs");
    }
    
    var errorConsole = Ext.create("Ext.grid.Panel", {
        title: "Error",
        id: "errorGrid",
        store: errorStore,
        selType: "cellmodel",
        emptyText: "No Errors to display",
        columns: [
            { header: "Type",  dataIndex: "type"},
            { header: "File", dataIndex: "file", flex: 1},
            { header: "Line", dataIndex: "linenumber"},
            { header: "Description", dataIndex: "description" ,flex: 1}
        ],      
        listeners : {
             itemclick : function(view, record, item, index, e, eOpts) {
                 console.log("Cell item: "+ record.get("file"));
                 var nodeText = record.get("name");
                 var tabPanel = viewport.getComponent("mytabpanel");
                 var tabBar = tabPanel.getTabBar();
                 var tabIndex;

                 for ( var i = 0; i < tabBar.items.length; i++) {
                     if (tabBar.items.get(i).getText() === nodeText) {
                         tabIndex = i;
                     }
                 }
                 console.log("Clicked on Node: " + record.data.text);
                 console.log("Getting file: "+"AndroidProjectFiles\\"+record.get("file"));
                 var nodeContent = getRemoteData(false, "AndroidProjectFiles/"+record.get("file"), "GET");
                 sourcecode = nodeContent[0];
                 
                 console.log("Clicked on Node: " + record.get("name"));
                 
                 if (Ext.isEmpty(tabIndex)) {
                     editor = Ext.create("Ext.ux.aceeditor.Panel", {
                         title : record.get("name"),
                         theme : "dreamweaver",
                         printMargin : true,
                         margins : "5 0 5 0",
                         itemId : record.get("text"),
                         parser : getParserType(record.get("name")),
                         closable : true,
                         animCollapse : true,
                         codeFolding : true,
                         sourceCode : sourcecode,
                         listeners : {
                             deactivate : function(panel, eOpts) {
                                 saveWhenDeactivated(panel, record);
                                 //console.log(panel.title   + " panel deactivated");
                             },
                             activate : function(panel, eOpts) {
                                 //console.log(panel.title   + " panel activated");
                             }
                         }
                     });
                     
                     tabPanel.add(editor).show();                        
                     tabIndex = tabPanel.items.length - 1;
                 }
                 tabPanel.setActiveTab(tabIndex);
                 
                 //console.log("text length: "+tabPanel.getActiveTab().getXType());
                 // sets the cursor where the error occurs
                 tabPanel.getActiveTab().getEditor().gotoLine(record.get("linenumber"));
                 //this.getEditor().gotoLine(contentLength);
             }
             },
             beforeactivate : function(view, option) {
                 errorStore.load();
                 console.log("before activate called");
             },
             activate : function(view, options) {
                 errorStore.load();
             }
    });
    
    var outputPanel = Ext.create("Ext.tab.Panel", {
        region : "south",
        itemId : "myoutputpanel",
        margins : "0 5 5 5",
        height : 300,
        //collapsible : true,
        //animCollapse : true,
        split : true,
        items: [outputConsole,errorConsole,LogConsole]
         
    });

    var saveWhenDeactivated = function(panel, filepath) {
        var afterEdit = panel.getValue();
        var beforeEdit = panel.sourceCode;
        
        // displaying information in console
        outputConsole.setValue("\nSaving contents of file "+panel.title+"\n");        
        
        if (afterEdit === beforeEdit) {
            console.log("Code is not changed");
        } else {
            var changedFile = filepath.get("id");
            var changedData = panel.getValue();
            
            //console.log("Data: "+ data);
            
            Ext.Ajax.request({
                url : "home",
                //disableCaching : false,
                method : "POST",
                params : {  
                    "action" : "save",
                    "filepath" : changedFile,
                    "filecontent" : changedData                 
                },
                success : function(response, options) {
                    //console.log(response.responseText);                                     
                },
                failure : function(response, options) {
                    //console.log('The Failure function was called.');                                      
                },
                callback : function(options, success, response) {
                    //console.log('The Callback function was called.');
                    //console.log('Successful Request? ' + success);                  
                },
                timeout : 60000
            });
        }
            console.log("Changed file :" + changedFile);    
            
            //console.log("Reloading tree");
            //westPanel.getStore().load();      
    };

    var viewport;

    Ext.require("Ext.ux.aceeditor.Panel");
    Ext.onReady(function() {
        viewport = Ext.create('Ext.container.Viewport', {
            layout : 'border',
            items : [ topToolbar, westPanel, outputPanel, {
                xtype : "tabpanel",
                itemId : "mytabpanel",
                region : "center",
                margins : "0 5 0 5"
            } ]
        });

    });

    //projectName = westPanel.store.getRootNode().getChildAt(0).text;
    
    //var store = westPanel.store;
    //console.log("FirstNode: "+ store.getRootNode().getChildAt(0).get("title"));
    var textOutput = getRemoteData(false, "home?action=buildoutput&name="+PROJECTNAME, "GET");
    outputConsole.sourceCode = textOutput[0];
    //westPanel.getStore().load();

    //console.log("Build Output: " + textOutput);
    /*Ext.onReady(function() {
    var menu = Ext.create('Ext.menu.Menu', {
        floating: true,
        items: [{
            text: 'regular item 1'},
        {
            text: 'regular item 2'},
        {
            text: 'regular item 3'}]
    });

    var div = Ext.get('test');
    div.on('mouseenter', function(e) {
        menu.showAt(e.getXY());
    });
    console.log(div);
});*/
</script>

</head>
<body>
</body>
</html>